<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ChatPayKit Checkout</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }

    body {
      height: 100vh;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 40px;
      width: 380px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .logo {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 10px;
      letter-spacing: 1px;
      color: #38bdf8;
    }

    h2 {
      font-size: 20px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .amount {
      font-size: 32px;
      font-weight: 700;
      margin: 15px 0;
      color: #22d3ee;
    }

    .desc {
      font-size: 14px;
      color: #cbd5e1;
      margin-bottom: 25px;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #06b6d4, #3b82f6);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59,130,246,0.4);
    }

    .footer {
      margin-top: 18px;
      font-size: 12px;
      color: #94a3b8;
    }
  </style>
</head>

<body>

  <div class="card">
    <div class="logo">üí¨ ChatPayKit</div>
    <h2>Secure Payment</h2>
    <div class="amount" id="displayAmount">‚Çπ --</div>
    <div class="desc" id="displayDesc">Processing your order securely</div>

    <button id="payBtn">Pay Securely</button>

    <div class="footer">
      Powered by Razorpay
    </div>
  </div>

  <script>
  const params = new URLSearchParams(window.location.search);

  const dbOrderId = params.get("dbOrderId");
  const orderId = params.get("orderId");
  const keyId = params.get("keyId");
  const amount = params.get("amount");
  const name = params.get("name") || "ChatPayKit";
  const desc = params.get("desc") || "Secure Payment";

  // ‚úÖ token can come from URL (recommended) or same-origin localStorage (works only if token stored on :8080)
  let token =
    params.get("token") ||
    localStorage.getItem("token") ||
    "";

  // If token accidentally stored with quotes like '"abc..."'
  if (token && token.startsWith('"') && token.endsWith('"')) {
    token = token.slice(1, -1);
  }

  // Show amount nicely
  if (amount) {
    const amt = Number(amount);
    if (!Number.isNaN(amt)) {
      document.getElementById("displayAmount").innerText = "‚Çπ " + (amt / 100).toFixed(2);
    }
  }
  document.getElementById("displayDesc").innerText = desc;

  async function verifyPayment(res) {
    if (!dbOrderId) throw new Error("Missing dbOrderId in URL");

    const body = {
      razorpayOrderId: res.razorpay_order_id,
      razorpayPaymentId: res.razorpay_payment_id,
      razorpaySignature: res.razorpay_signature,
    };

    const headers = { "Content-Type": "application/json" };
    if (token) headers["Authorization"] = `Bearer ${token}`;

    // NOTE: since checkout.html is served from :8080, relative URL is fine.
    // Using absolute is also fine if you prefer: `http://localhost:8080/api/orders/...`
    const r = await fetch(`/api/orders/${dbOrderId}/verify`, {
      method: "POST",
      headers,
      body: JSON.stringify(body),
    });

    const text = await r.text(); // may be empty or JSON or plain text

    if (!r.ok) {
      // try to extract message from JSON error
      try {
        const j = text ? JSON.parse(text) : null;
        throw new Error(j?.message || j?.error || text || `Verify failed (${r.status})`);
      } catch (_) {
        throw new Error(text || `Verify failed (${r.status})`);
      }
    }

    // if backend returns JSON, return it; else return text
    try {
      return text ? JSON.parse(text) : { ok: true };
    } catch (_) {
      return text || "OK";
    }
  }

  document.getElementById("payBtn").onclick = function () {
    if (!dbOrderId) return alert("Missing dbOrderId in URL");
    if (!orderId) return alert("Missing Razorpay orderId in URL");
    if (!keyId) return alert("Missing Razorpay keyId in URL");
    if (!amount) return alert("Missing amount in URL");

    const options = {
      key: keyId,
      amount: Number(amount),
      currency: "INR",
      name,
      description: desc,
      order_id: orderId,
      theme: { color: "#3b82f6" },

      handler: async function (res) {
        try {
          await verifyPayment(res);
          alert("Payment verified ‚úÖ " + res.razorpay_payment_id);
        } catch (e) {
          alert("Payment success but verify failed ‚ùå " + (e?.message || e));
        }
      },

      modal: {
        ondismiss: function () {
          console.log("Checkout closed by user");
        },
      },
    };

    new Razorpay(options).open();
  };
</script>


</body>
</html>
